<!DOCTYPE html>
<html>
   <head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <script type="text/javascript" src="https://rise.mpiwg-berlin.mpg.de/jslib/rise_client.js"></script>
      <script src="./js/jquery.min.js"></script>
      <script src="./js/FileSaver.min.js"></script>
      <script src="./js/jquery-ui.min.js"></script>
      <script src="./js/jquery.csv.js"></script>
   
      <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/xmlwriter@1.0.2/XMLWriter.min.js"></script>
      <link href="./js/jquery-ui.min.css" rel="stylesheet">
      <script src="https://docusky.org.tw/DocuSky/js.ui/docusky.ui.manageDbListSimpleUI.js"></script>
      <style id="dsw-simplecomboui">div.dsw-container { position:absolute; border:#4F4F4F solid 3px; background-color:#EFEFEF; border-radius:4px; display:inline-block; font-family: "Arial","MingLiU"; font-size: 16px; z-index:1001 }div.dsw-titleBar { background-color:#4F4F4F; color:white; z-index:1001; padding: 6px; line-height: 16px; }div.dsw-containerContent { padding: 6px; overflow-x:hidden; overflow-y:auto; font-size:medium; z-index:1001 }.dsw-titleBar table,.dsw-containerContent table { width: 100%; line-height:1.3em; border-collapse: collapse; border-spacing:0; }table.dsw-tableDbCorpuslist { width:100%; margin-right: 16px; border-collapse: collapse; border-spacing: 0; font-size:medium; line-height:1.3em; color:#2F2F3F; }tr.dsw-tr-dbcorpuslist:nth-child(even) { background: #DFDFDF; line-height:1.3em; }tr.dsw-tr-dbcorpuslist:nth-child(odd)  { background: #FFFFFF; line-height:1.3em; }.dsw-titleContainer { width: 60%; padding: 0; }.dsw-closeContainer { position: relative; text-align: right; direction: rtl; padding: 0; }.dsw-titlename { display: inline-block; line-height: 16px; white-space: nowrap; }.dsw-btn-docusky { position: absolute; color:#2F2F2F; background-color:#EFEFEF; border-radius: 3px; font-size: 0.75rem; line-height: 0.75rem; padding: 4px; margin: 0 24px 0 0; cursor: pointer; }.dsw-btn-docusky:hover { background-color:#BFBFBF; color:#96438A; }.dsw-btn-docusky:active { background-color:#BFBFBF; color:#96438A; }.dsw-btn-close { display: inline-block; line-height: 16px; cursor: pointer; }.dsw-btn-close:hover { background-color:#BFBFBF; color:#96438A; }.dsw-btn-close:active { background-color:#BFBFBF; color:#96438A; }.dsw-td-dbcorpuslist { vertical-align: middle; padding: 0.25rem;}.dsw-td-dbcorpuslist-num { text-align: right;}.dsw-displaynameContainer { display: inline-block; width: 50px; white-space: nowrap; overflow: visible; margin: 0 72px 0 0; }.dsw-displayname { display: inline-block; direction: ltr; }.dsw-btn-logout { position: absolute; right: 0; top: -2px; color:#2F2F2F; background-color:#EFEFEF; border-radius: 3px; font-size: 0.75rem; line-height: 0.75rem; padding: 4px; margin: 0 24px 0 0; cursor: pointer; }.dsw-btn-logout:hover { background-color:#BFBFBF; color:#96438A; }.dsw-btn-logout:active { background-color:#BFBFBF; color:#96438A; }.dsw-overlay { display: none; position: absolute; background-color: #AAAAAA; opacity: 0.5; z-index: 1002; height: 100%; width: 100%; }input[type="text"].dsw-userinput,input[type="password"].dsw-userinput { box-sizing: content-box; padding: 2px 8px; border: 1px solid grey; border-radius: 2px; font-size: 14px; height: 20px; width: 150px; }.dsw-td-dslogin { padding: 0; height: 1.75rem; vertical-align: middle; }.dsw-logintitle { padding-right: 6px; }.dsw-loginsubmit { direction: rtl; }.dsw-loginmsg { padding: 0; color: red; font-size: 12px; font-weight: bold; }table.dsw-filenameList { width: 100%; margin-right: 16px; border-collapse: collapse; border-spacing: 0; line-height: 1.25; }.dsw-filenameList td { padding: 0.25rem; vertical-align: top; white-space: nowrap; }.dsw-filenameList-id { text-align: right; }.dsw-filename-download,.dsw-filename.delete { text-align: center; }.dsw-filenameList-category,.dsw-filenameList-path { text-align: left; overflow-x: hidden; text-overflow: ellipsis; }.dsw-filenameList-id {}.dsw-filenameList-download,.dsw-filenameList-delete { width: 45px; max-width: 45px; text-align: center; }.dsw-filenameList-category { font-weight: bold; min-width: 120px; max-width: 150px; }.dsw-filenameList-path { min-width: 450px; max-width: 550px; }.table.dsw-uploadfile{ width: 100%; border-collapse: collapse; border-spacing: 0; }.dsw-uploadfile td { padding: 0; }.dsw-td-dbList { padding: 0.25rem; }.dsw-td-dbList-dbname,.dsw-td-dbList-corpusnames{ text-align:left; border:1px solid #5C5C5C; }.dsw-td-dbList-delete{ text-align: center;  border:1px solid #5C5C5C; }.dsw-td-dbList-dbname{ font-weight:600; min-width: 100px; max-width:180px; word-wrap: break-word; word-break: break-all; }.dsw-td-dbList-corpusnames{ min-width: 450px; max-width: 550px; }.dsw-td-dbList-delete{ min-width:40px; max-width: 60px; white-space: nowrap; }.dsw-dbList-corpusnames-corpusname { display: inline-block; vertical-align: middle; white-space: nowrap; max-width: 250px; overflow-x: hidden; text-overflow: ellipsis; }.dsw-uploadprogressbar { display: none; box-sizing: border-box; height: 20px; width: 100%; margin: 0; padding: 0; border: 1px solid #515F6B; border-radius: 3px; overflow: hidden; background-color: #AFB9C3; }.dsw-uploadprogressbar-progress { display: block; height: 100%; margin: 0; padding: 0; border: 0; background-color: #4C93D4; text-align: center; color: white; white-space: nowrap; }.dsw-dbClick { cursor:pointer; text-decoration:underline; color:blue; }.dsw-corpusAttCntClick { cursor:pointer; text-decoration:underline; color:blue; }.dsw-corpusClick { cursor:pointer; text-decoration:underline; color:blue; }.dsw-attCntClick { cursor:pointer; text-decoration:underline; color:blue; }</style>
      <script>
         window.addEventListener('load', function () {

            rise.init.setRemote();

            DocuSkyObj = docuskyManageDbListSimpleUI;
            $(document).on('click','#manageDbList',function(e){
               DocuSkyObj.manageDbList(e);
            });
            
            
            $("").click(function(e) {
               console.log('click');
               //
            });

            Vue.component('selectCollection', {
               template: `<select v-bind:value="value" @input="$emit('input', $event.target.value)"><option value='0'>Select a Collection</option><option v-for="collection in collections" v-bind:value="collection.uuid">{{ collection["name"] }}</option></select>`,
               props: {
                  value: String,
                  collections: Array
                  
               },
               watch: {
		            value: function(newValue){
			            this.currentOption = newValue;
		            }
	            }
            });

            Vue.component('progressBar', {
               template: `<div class='progress-bar-outer' v-if='progress > 1'><div class='progress-bar-inner' v-bind:style="{ width: progress + '%' }"></div></div>`,
               computed: {
                  progress(){
                     if(this.goal == 0) {
                        return 0;
                     }
                     return Math.ceil((this.current/this.goal) * 100);
                  }
               },
               
               props: {
                  'current': Number,
                  'goal': Number
               
               },
               watch: {
		            value: function(newValue){
			            this.currentOption = newValue;
		            }
	            }
            });

            var app = new Vue({
               el: '#app',
               data() {
                  return {
                     collections: [],
                     selectedCollection: '0',
                     resourceSearchString: '',
                     resources: [],
                     selectedResources: [],
                     resourcesForExport: [],
                     currentPage: 1,
                     totalResources: 0,
                     perPage: 25,
                     filter: ""
                  }
               },
               watch: {
                  selectedCollection: function(uuid, oldUuid) {
                     this.getResources(uuid,this.currentPage, '');
                     this.currentPage = 1;
                     this.filter = '';
                  },
                  filter: function(filterValue, oldUuid) {
                     this.currentPage = 1;
                     this.getResources(this.selectedCollection,this.currentPage, filterValue);
                  }
               },
               computed: {
                  pageCount(){
                     return Math.ceil(this.totalResources/this.perPage);
                  },
                  selectedResourcesCount(){
                     return this.selectedResources.length;
                  },
                  resourcesForExportCount(){
                     return this.resourcesForExport.length;
                  },
                  currentCollectionName(){
                     const el =  this.collections.find(c => c.uuid==this.selectedCollection)
                     if(el){
                        return el.name
                     }
                  }
               },
               created(){
                  this.getCollections();

               },
               methods: {
                  removeSelectedResource(index) {
                    this.selectedResources.splice(index, 1);
                  },
                  async getCollections() {
                     rise.collections.all()
                        .then(response => {
                        this.collections = response.body;
                     })
                     .catch(error => {
                       console.log(error.response.body);
                       console.log(error.status);
                     })
                  },
                  reInit(){
                     this.selectedResources = [];
                     this.resourcesForExport = [];
                     this.selectedCollection = '0';

                  },
                  buildXML(resources){
                     var xw = new XMLWriter('UTF-8');
                     xw.formatting = 'indented';
                     xw.indentChar = ' ';
                     xw.indentation = 2;

                     xw.writeStartDocument( );
                     //xw.writeDocType('xml version="1.0"');
                        xw.writeStartElement( 'ThdlPrototypeExport' );
                           xw.writeStartElement( 'documents' );
                              for(const resource of resources ) {
                                 xw.writeComment('document');
                                 xw.writeStartElement('document');
                                    xw.writeElementString('corpus', resource.collectionName);
                                    xw.writeAttributeString( 'uuid', resource['uuid']);
                                    xw.writeAttributeString( 'filename', resource['name']);
                                    for(const section of resource['sections']){
                                       xw.writeElementString('paragraph', section['content_units'].map(cu => cu.content).join('<br>'));
                                    }

                                 xw.writeEndElement();
                              
                              }
                           xw.writeEndElement();
                     xw.writeEndElement();
                     xw.writeEndDocument();
                     var xml = xw.flush();
                     xw.close();
                     var blob = new Blob([xml], {type: "text/plain;charset=utf-8"});
                     saveAs(blob, "DefaultExport.xml");
                     this.reInit();      
                  },
                  async buildJson() {
                     var promises = [];
                     var tempResources = [];
                     for(const resource of this.selectedResources) {
                        resourceForExport = { ...resource, sections: [] };
                        promises.push(await rise.resources.sections(resource.uuid, {per_page: 6000}).then(response => {
                           resourceForExport['sections'] = response.body;
                           tempResources.push(resourceForExport);
                        }));
                     }
                     await Promise.all(promises);
                     promises = [];
                     for(const resource of tempResources) {

                        // sol 1 :
                        resourceMap = { ...resource, sections: [] };
                        console.log(resourceMap);

                        for(const section of resource['sections']) {
                           tempSection = {};
                           tempSection['name'] = section['name'];
                           tempSection['uuid'] = section['uuid'];
                           tempSection['content_units'] = [];
                           promises.push(
                              await rise.sections.contentUnits(section.uuid, {per_page: 6000})
                              .then(response => {
                                 tempSection['content_units'] = response.body;
                                 resourceMap['sections'].push(tempSection);
                              })
                           );
                        }
                        this.resourcesForExport.push(resourceMap);
                     }
                     await Promise.all(promises);
                     this.buildXML(this.resourcesForExport);
                  },
                  nextPage() {
                     this.currentPage += 1;
                     this.getResources(this.selectedCollection, this.currentPage);
                  },
                  prevPage() {
                     this.currentPage -= 1;
                     this.getResources(this.selectedCollection, this.currentPage);
                  },
                  getResources(uuid, page, filter) {
                     this.resources = [];

                     if (uuid == 0) {
                        rise.resources.all({filter: this.filter, page: page}).then(response => {
                           this.resources = response.body;
                           this.totalResources = response.headers['x-total'];
                        })
                        return;
                     }
                     rise.collections.resources(uuid, {page: page, filter: filter})
                        .then(response => {
                           resources = response.body;
                           for(const resource of resources) {
                              var tempResource = {...resource, collectionName: this.currentCollectionName};
                              this.resources.push(tempResource);
                           }
                           this.totalResources = response.headers['x-total'];
                        })
                        .catch(error => {
                           console.log(error.response.body);
                           console.log(error.status);
                        })
                  }
               }
            });
         })
      </script>   
      <style type="text/css">
         [v-cloak] {display: none}
         body { Verdana, Arial, Helvetica, sans-serif, times, Microsoft JhengHei, Heiti TC, PMingLiU, PMingLiu-ExtB, SimSun, SimSun-ExtB, HanaMinA, HanaMinB;
               margin:0; line-height:160%; }
         div.headerBar { background-color:rgb(41,60,65); color:white; padding:8px; text-align: center; }
         table.headerBar { color:rgb(205,174,94); }
         div.contentArea { padding: 12px; }
         table.selectTexts { padding:5px; border:3px solid rgb(180,123,47); background-color:rgb(180,123,47); border-radius:5px; }
         span.butBuildDb { padding:5px; background-color:rgb(122,23,30); color:rgb(205,174,94); 
                           border-radius:3px; cursor:pointer; }
         div.sampleFilesArea { padding:6px; border:3px solid rgb(180,123,47); background-color:rgb(180,123,47); border-radius:4px; }
         a:visited, a:link { color:rgb(122,23,30); }
         a.topAnchor:visited, a.topAnchor:link { color:rgb(225,225,225); cursor:pointer; }
         span.topAnchorSeparator { color:rgb(225,225,225); }
         textarea { resize:none; background-color:rgb(205,174,94); border:2px solid rgb(126,102,80); }
         input#selectInFile { background-color:rgb(180,123,47); }
         span.bookTitle { font-size:80%; margin:2px; padding:6px; border:1px solid black;  }
         
         td.textTitles:nth-child(2n) { background-color:#DFDFFF; }
         td.textTitles:nth-child(2n+1) { background-color:#DFFFDF; }
         span.selectedBook { font-size:80%; margin:2px; padding:2px; border:1px solid black; }

         .remove-button {
            margin: 1px;
         }


         .progress-bar-outer {
            margin-top: 8px;
            height: 8px;
            background: #4C93D4;
            width: 50%;
         }

         .progress-bar-inner {
            height: 8px;
            background: #96438A;
            width: 0%;
         }
         
         .linear-gradient-headerBar {
            background-color: rgb(41,60,65);
            background-image: -webkit-linear-gradient(left, #778899, rgba(41,60,65,0.8));
            background-image: -moz-linear-gradient(left, #778899, rgba(41,60,65,0.8));
            background-image: -o-linear-gradient(left, #778899, rgba(41,60,65,0.8));
            background-image: -ms-linear-gradient(left, #778899, rgba(41,60,65,0.8));
            background-image: linear-gradient(to left, #778899, rgba(41,60,65,0.8));
         }
         
         .linear-gradient-InputSelection {
            background-color: rgb(180,123,47);
            background: radial-gradient(rgb(205,174,94,0.9), rgba(205,174,94,0.1));
         }

         #pagination-filter{
            width:100%;margin-left:3px;
         }

         .paginationContainer {
            float: right;
         }

         .paginationInfo {
            float: right;
         }

         .pagination ul {
            margin-top: 0px!important;
         }

         .pagination ul li {
            display: inline-block;
            float: left;
            margin: 0 5px 0 0;
         }
         
   </style>
   </head>
   <body cz-shortcut-listen="true">
      <div id="app">
      <div id="headerBar" class="headerBar linear-gradient-headerBar">
         <table class="headerBar" width="100%">
         <tbody>
               <tr>
                  <td width="120" style="font-size:120%"><b>DocuSky</b><span style="font-size:60%;vertical-align:sub">BETA</span></td>
                  <td><span style="font-size:110%">從 RISE 下載全文，組成 DocuXml 並可上載建庫的小工具</span></td>
                  <td align="right">
                  <a class="topAnchor" href="http://docusky.org.tw/DocuSky/">首頁</a> 
                  <span class="topAnchorSeparator">|</span> <a class="topAnchor" href="http://docusky.org.tw/DocuSky/docuTools/userMain/">我的資料庫</a>
                  </td>
               </tr>
            </tbody>
         </table>
      </div>
      <div style="padding:5px;">
         <table>
         <tbody>
            <tr>
                  <td colspan="2">
                  <b>1. Select a Collection:</b>
                  <select-collection v-model="selectedCollection" :collections="collections"></select-collection>
                  </td>
               </tr>
            <tr>
         </tbody>
         </table>
         <div id="pagination-filter" v-cloak>
            <div style="float:left;margin-right:10px">
               書名過濾: <input id="inputBookFilter" type="text" size="6" autocomplete="off" v-model="filter">
            </div>
            <div id="paginationContainer">
               <div class="pagination">
                  <ul>
                     <li v-if="pageCount > 1">
                        <button @click="prevPage" :disabled="currentPage === 1">&lt;</a>
                     </li>
                     <li v-if="pageCount > 1">
                        <button @click="nextPage" :disabled="currentPage >= pageCount">
                           &gt;
                        </a>
                     </li>
                  </ul>
                  <span style="color: #f00">{{currentPage}}</span> / {{pageCount}} pages, {{totalResources}} entries
               </div>
            </div>
         </div>
         <div style="clear:both"></div>
      <div style="overflow-x:hidden; overflow-y:scroll; height:280px; border:2px solid grey; border-radius:4px; margin:5px; box-shadow:5px 5px 5px #888888;">
         <div id="messageOverlay" style="position: absolute; top: 180px; left: 25%; width: 50%; border: 3px double grey; border-radius: 4px; padding: 18px; font-size: 125%; background-color: rgb(255, 255, 153); z-index: 100; text-align: center; display: none;">載入書名清單...</div>
            <table id="resourcesList" width="100%">
               <tbody>
                  <tr v-cloak v-for="resource in resources"><td v-bind='resource'><label><input type='checkbox' v-model="selectedResources" :id=resource.uuid :value=resource>{{resource.name}}</label></td></tr>
               </tbody>
            </table>
         </div>
         <div style="margin-left:10px; padding:3px;" v-cloak>
            <span>{{selectedResources.length}}</span> resources selected
            <span style="margin-left:10px">
               <span class="bookTitle" v-for="(resource, index) in selectedResources" :key='resource.id'>{{resource.collectionName}} > {{resource.name}}&nbsp;<button class="remove-button" @click="removeSelectedResource(index)">x</button></span>
            </span>
         </div>
         </div>
         <div class="contentArea">
            <!--
            <b>1. 先 <button id="downloadTexts" disabled="disabled">下載</button> ctext 文本
            <br/>
            -->
            <hr>
            <b>2. 將 DocuXml 儲存在本地硬碟</b><br>
         輸出的建庫檔名：<input type="text" id="outFilename" placeholder="DefaultExport.xml" value="" size="45" autocomplete="off">
            <button id="downloadAndSave" @click="buildJson" :disabled="selectedResourcesCount < 1">點我下載並儲存</button>
            <progress-bar :current='resourcesForExportCount' :goal='selectedResourcesCount'></progress-bar>
         </div>
         <br>
         <hr>
         <table width="100%" border="0">
            <tbody><tr id="transformers" class="tableRow">
               <td width="100%" class="toolType">
                  <b>3. 上載 DocuXml 檔案，以建構個人文字庫（需有 DocuSky 帳號）</b><br>
               </td>
            </tr>
            <tr>
               <td style="padding:10px">
                  <div>
                  <span id="manageDbList" class="butBuildDb">
                     點我建構或刪除文字庫
                  </span><span style="font-size:smaller">（檔案大小上限 100MB）</span>
                  </div>
               </td>
            </tr>
         </tbody>
      </table>
      </div>
   </div>
   </body>
</html>